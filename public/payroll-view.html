<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Payroll | Nebula Payroll</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="subtle-bg">
    <header class="app-header">
      <div class="app-header__brand">Nebula Payroll</div>
      <div class="app-header__actions">
        <button id="logoutBtn" class="btn ghost small">Log Out</button>
      </div>
    </header>

    <div class="app-layout">
      <nav class="sidebar" aria-label="Primary">
        <div class="nav-group">
          <div class="nav-label">Main</div>
          <a class="nav-link" href="/dashboard.html">Dashboard</a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Payroll</div>
          <a class="nav-link" href="/payroll-new.html">Run a New Payroll</a>
          <a class="nav-link" href="/payroll-atf.html">Run ATF Payroll</a>
          <a class="nav-link active" aria-current="page" href="/payroll-view.html">View Payroll</a>
          <a class="nav-link" href="/payroll-print.html">Print Payroll</a>
          <a class="nav-link" href="/payroll-void.html">Void Payroll</a>
          <a class="nav-link" href="/pay-types.html">Edit Pay Types</a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Employees</div>
          <a class="nav-link" href="/employees.html">List Employees</a>
          <a class="nav-link" href="/employee-add.html">Add Employee</a>
          <a class="nav-link" href="/pay-schedules.html">Edit Pay Schedules</a>
          <a class="nav-link" href="/manage-pto.html">Manage PTO</a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Time Tracking</div>
          <a class="nav-link" href="/timesheets.html">Timesheets</a>
          <a class="nav-link" href="/approvals.html">Approvals</a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Reports</div>
          <a class="nav-link" href="/reports.html">View Reports</a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Settings</div>
          <a class="nav-link" href="/settings.html">Company Settings</a>
        </div>
      </nav>

      <main class="workspace">
        <section class="workspace__heading">
          <h1>View Payroll</h1>
          <p class="lead">Review paid payroll runs, edit labels, and preview employee pay stubs.</p>
        </section>

        <section class="panel">
          <div class="flex" style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <h2 style="margin: 0 0 4px;">Payroll runs</h2>
              <p class="muted" style="margin: 0;">Paid payroll periods and their employee summaries.</p>
            </div>
            <div class="actions">
              <a class="btn ghost small" href="/payroll-new.html">Run payroll</a>
              <a class="btn primary small" href="/payroll-print.html">Print payroll</a>
            </div>
          </div>

          <div id="payrollStatus" class="muted" style="margin-top: 12px;"></div>
          <div id="payrollNotice" class="notice" style="display: none; margin-top: 12px;"></div>

          <div style="overflow-x: auto; margin-top: 12px;">
            <table class="table" aria-label="Payroll runs">
              <thead>
                <tr>
                  <th>Pay period</th>
                  <th>Employees</th>
                  <th class="right">Total hours</th>
                  <th class="right">Gross pay</th>
                  <th class="right">Net pay</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="runsBody"></tbody>
            </table>
          </div>
        </section>

        <section class="panel" style="margin-top: 20px;">
          <div class="flex" style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <h2 style="margin: 0 0 4px;">Payroll details</h2>
              <p class="muted" style="margin: 0;">Select a payroll run to review employee totals and pay stubs.</p>
            </div>
          </div>

          <div id="detailsEmpty" class="muted" style="margin-top: 12px;">Select a payroll run to see details.</div>

          <div id="detailsPanel" style="display: none; margin-top: 16px;">
            <div class="form-grid" style="margin-bottom: 16px;">
              <div>
                <label for="runLabel">Payroll run label</label>
                <input id="runLabel" type="text" placeholder="e.g., March 2024 Run" />
              </div>
              <div style="display: flex; align-items: flex-end; gap: 12px;">
                <button class="btn primary" id="saveLabel">Save label</button>
                <button class="btn ghost" id="deleteRun">Delete run</button>
                <span class="muted" id="runActionStatus"></span>
              </div>
            </div>

            <div style="overflow-x: auto;">
              <table class="table" aria-label="Payroll detail summary">
                <thead>
                  <tr>
                    <th>Employee</th>
                    <th class="right">Total hours</th>
                    <th class="right">Gross pay</th>
                    <th class="right">Net pay</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="detailsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="panel" style="margin-top: 20px;">
          <div class="flex" style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <h2 style="margin: 0 0 4px;">Worksheet 1A & Percentage Method Tables</h2>
              <p class="muted" style="margin: 0;">Reference the IRS worksheet for automated payroll systems.</p>
            </div>
          </div>

          <details style="margin-top: 12px;">
            <summary class="btn ghost small">Show Worksheet 1A and tables</summary>
            <div style="margin-top: 12px;">
              <p class="muted">
                If you’re an employer with an automated payroll system, use Worksheet 1A and the Percentage Method tables in this section to
                figure federal income tax withholding. This method works for Forms W-4 for all prior, current, and future years. This method
                also works for any amount of wages. If the Form W-4 is from 2019 or earlier, this method works for any number of withholding
                allowances claimed.
              </p>
              <p class="muted">
                If you’re a payer making periodic payments of pensions and annuities, use Worksheet 1B and the Percentage Method tables in
                this section to figure federal income tax withholding. This method works for Forms W-4P for all prior, current, and future years.
              </p>

              <div class="form-grid" style="margin-top: 16px;">
                <div>
                  <h3 style="margin: 0 0 8px;">Worksheet 1A. Employer’s Withholding Worksheet</h3>
                  <ol class="muted" style="margin: 0; padding-left: 18px;">
                    <li>Enter total taxable wages this payroll period.</li>
                    <li>Enter number of pay periods per year (see Table 3).</li>
                    <li>Multiply line 1a by 1b.</li>
                    <li>Add Step 4(a) from Form W-4.</li>
                    <li>Subtract Step 4(b) and standard deduction amount (if Step 2 box is not checked).</li>
                    <li>Compute Adjusted Annual Wage Amount.</li>
                    <li>Find the row in the appropriate Annual Percentage Method table.</li>
                    <li>Compute Tentative Withholding Amount and divide by pay periods.</li>
                    <li>Subtract Step 3 credits per pay period.</li>
                    <li>Add additional withholding from Step 4(c).</li>
                  </ol>
                </div>
                <div>
                  <h3 style="margin: 0 0 8px;">Table 3. Pay periods per year</h3>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>Cadence</th>
                        <th class="right">Pay periods</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>Weekly</td><td class="right">52</td></tr>
                      <tr><td>Biweekly</td><td class="right">26</td></tr>
                      <tr><td>Semimonthly</td><td class="right">24</td></tr>
                      <tr><td>Monthly</td><td class="right">12</td></tr>
                      <tr><td>Quarterly</td><td class="right">4</td></tr>
                      <tr><td>Semiannually</td><td class="right">2</td></tr>
                      <tr><td>Daily</td><td class="right">260</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <h3 style="margin: 16px 0 8px;">2026 Percentage Method Tables (Standard)</h3>
              <p class="muted" style="margin-top: 0;">Use these if Form W-4 is from 2019 or earlier, or if the Step 2 checkbox is not checked.</p>
              <div class="table-grid">
                <div>
                  <h4 style="margin: 0 0 6px;">Married Filing Jointly</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$19,300</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$19,300</td><td>$44,100</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$19,300</td></tr>
                      <tr><td>$44,100</td><td>$120,100</td><td class="right">$2,480.00</td><td class="right">12%</td><td class="right">$44,100</td></tr>
                      <tr><td>$120,100</td><td>$230,700</td><td class="right">$11,600.00</td><td class="right">22%</td><td class="right">$120,100</td></tr>
                      <tr><td>$230,700</td><td>$422,850</td><td class="right">$35,932.00</td><td class="right">24%</td><td class="right">$230,700</td></tr>
                      <tr><td>$422,850</td><td>$531,750</td><td class="right">$82,048.00</td><td class="right">32%</td><td class="right">$422,850</td></tr>
                      <tr><td>$531,750</td><td>$788,000</td><td class="right">$116,896.00</td><td class="right">35%</td><td class="right">$531,750</td></tr>
                      <tr><td>$788,000</td><td>—</td><td class="right">$206,583.50</td><td class="right">37%</td><td class="right">$788,000</td></tr>
                    </tbody>
                  </table>
                </div>
                <div>
                  <h4 style="margin: 0 0 6px;">Single or Married Filing Separately</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$7,500</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$7,500</td><td>$19,900</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$7,500</td></tr>
                      <tr><td>$19,900</td><td>$57,900</td><td class="right">$1,240.00</td><td class="right">12%</td><td class="right">$19,900</td></tr>
                      <tr><td>$57,900</td><td>$113,200</td><td class="right">$5,800.00</td><td class="right">22%</td><td class="right">$57,900</td></tr>
                      <tr><td>$113,200</td><td>$209,275</td><td class="right">$17,966.00</td><td class="right">24%</td><td class="right">$113,200</td></tr>
                      <tr><td>$209,275</td><td>$263,725</td><td class="right">$41,024.00</td><td class="right">32%</td><td class="right">$209,275</td></tr>
                      <tr><td>$263,725</td><td>$648,100</td><td class="right">$58,448.00</td><td class="right">35%</td><td class="right">$263,725</td></tr>
                      <tr><td>$648,100</td><td>—</td><td class="right">$192,979.25</td><td class="right">37%</td><td class="right">$648,100</td></tr>
                    </tbody>
                  </table>
                </div>
                <div>
                  <h4 style="margin: 0 0 6px;">Head of Household</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$15,550</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$15,550</td><td>$33,250</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$15,550</td></tr>
                      <tr><td>$33,250</td><td>$83,000</td><td class="right">$1,770.00</td><td class="right">12%</td><td class="right">$33,250</td></tr>
                      <tr><td>$83,000</td><td>$121,250</td><td class="right">$7,740.00</td><td class="right">22%</td><td class="right">$83,000</td></tr>
                      <tr><td>$121,250</td><td>$217,300</td><td class="right">$16,155.00</td><td class="right">24%</td><td class="right">$121,250</td></tr>
                      <tr><td>$217,300</td><td>$271,750</td><td class="right">$39,207.00</td><td class="right">32%</td><td class="right">$217,300</td></tr>
                      <tr><td>$271,750</td><td>$656,150</td><td class="right">$56,631.00</td><td class="right">35%</td><td class="right">$271,750</td></tr>
                      <tr><td>$656,150</td><td>—</td><td class="right">$191,171.00</td><td class="right">37%</td><td class="right">$656,150</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <h3 style="margin: 16px 0 8px;">2026 Percentage Method Tables (Step 2 Checkbox)</h3>
              <p class="muted" style="margin-top: 0;">Use these if the Step 2 checkbox on Form W-4 is checked.</p>
              <div class="table-grid">
                <div>
                  <h4 style="margin: 0 0 6px;">Married Filing Jointly</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$16,100</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$16,100</td><td>$28,500</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$16,100</td></tr>
                      <tr><td>$28,500</td><td>$66,500</td><td class="right">$1,240.00</td><td class="right">12%</td><td class="right">$28,500</td></tr>
                      <tr><td>$66,500</td><td>$121,800</td><td class="right">$5,800.00</td><td class="right">22%</td><td class="right">$66,500</td></tr>
                      <tr><td>$121,800</td><td>$217,875</td><td class="right">$17,966.00</td><td class="right">24%</td><td class="right">$121,800</td></tr>
                      <tr><td>$217,875</td><td>$272,325</td><td class="right">$41,024.00</td><td class="right">32%</td><td class="right">$217,875</td></tr>
                      <tr><td>$272,325</td><td>$400,450</td><td class="right">$58,448.00</td><td class="right">35%</td><td class="right">$272,325</td></tr>
                      <tr><td>$400,450</td><td>—</td><td class="right">$103,291.75</td><td class="right">37%</td><td class="right">$400,450</td></tr>
                    </tbody>
                  </table>
                </div>
                <div>
                  <h4 style="margin: 0 0 6px;">Single or Married Filing Separately</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$8,050</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$8,050</td><td>$14,250</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$8,050</td></tr>
                      <tr><td>$14,250</td><td>$33,250</td><td class="right">$620.00</td><td class="right">12%</td><td class="right">$14,250</td></tr>
                      <tr><td>$33,250</td><td>$60,900</td><td class="right">$2,900.00</td><td class="right">22%</td><td class="right">$33,250</td></tr>
                      <tr><td>$60,900</td><td>$108,938</td><td class="right">$8,983.00</td><td class="right">24%</td><td class="right">$60,900</td></tr>
                      <tr><td>$108,938</td><td>$136,163</td><td class="right">$20,512.00</td><td class="right">32%</td><td class="right">$108,938</td></tr>
                      <tr><td>$136,163</td><td>$328,350</td><td class="right">$29,224.00</td><td class="right">35%</td><td class="right">$136,163</td></tr>
                      <tr><td>$328,350</td><td>—</td><td class="right">$96,489.63</td><td class="right">37%</td><td class="right">$328,350</td></tr>
                    </tbody>
                  </table>
                </div>
                <div>
                  <h4 style="margin: 0 0 6px;">Head of Household</h4>
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>At least</th>
                        <th>But less than</th>
                        <th class="right">Base</th>
                        <th class="right">Rate</th>
                        <th class="right">Excess over</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>$0</td><td>$12,075</td><td class="right">$0.00</td><td class="right">0%</td><td class="right">$0</td></tr>
                      <tr><td>$12,075</td><td>$20,925</td><td class="right">$0.00</td><td class="right">10%</td><td class="right">$12,075</td></tr>
                      <tr><td>$20,925</td><td>$45,800</td><td class="right">$885.00</td><td class="right">12%</td><td class="right">$20,925</td></tr>
                      <tr><td>$45,800</td><td>$64,925</td><td class="right">$3,870.00</td><td class="right">22%</td><td class="right">$45,800</td></tr>
                      <tr><td>$64,925</td><td>$112,950</td><td class="right">$8,077.50</td><td class="right">24%</td><td class="right">$64,925</td></tr>
                      <tr><td>$112,950</td><td>$140,175</td><td class="right">$19,603.50</td><td class="right">32%</td><td class="right">$112,950</td></tr>
                      <tr><td>$140,175</td><td>$332,375</td><td class="right">$28,315.50</td><td class="right">35%</td><td class="right">$140,175</td></tr>
                      <tr><td>$332,375</td><td>—</td><td class="right">$95,585.50</td><td class="right">37%</td><td class="right">$332,375</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </details>
        </section>
      </main>
    </div>

    <div class="modal" id="stubModal" aria-hidden="true">
      <div class="modal__backdrop" data-close></div>
      <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="stubTitle">
        <div class="modal__header">
          <div>
            <h3 id="stubTitle" style="margin: 0;">Pay stub preview</h3>
            <p class="muted" id="stubSubtitle" style="margin: 4px 0 0;"></p>
          </div>
          <button class="btn ghost small" type="button" data-close>Close</button>
        </div>
        <div id="stubContent"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem('payrollAuthToken');
      if (!token) {
        window.location.href = '/';
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('payrollAuthToken');
        window.location.href = '/';
      });

      const runsBody = document.getElementById('runsBody');
      const payrollStatus = document.getElementById('payrollStatus');
      const payrollNotice = document.getElementById('payrollNotice');
      const detailsEmpty = document.getElementById('detailsEmpty');
      const detailsPanel = document.getElementById('detailsPanel');
      const detailsBody = document.getElementById('detailsBody');
      const runLabelInput = document.getElementById('runLabel');
      const saveLabelBtn = document.getElementById('saveLabel');
      const deleteRunBtn = document.getElementById('deleteRun');
      const runActionStatus = document.getElementById('runActionStatus');
      const stubModal = document.getElementById('stubModal');
      const stubContent = document.getElementById('stubContent');
      const stubSubtitle = document.getElementById('stubSubtitle');

      const SS_RATE = 0.062;
      const MEDICARE_RATE = 0.0145;
      const SS_WAGE_BASE = 160200;
      const STANDARD_DEDUCTION = {
        married: 12900,
        single: 8600,
        head: 8600
      };

      let payTypes = [];
      let employees = [];
      let paySchedules = [];
      let payrollRuns = [];
      let paidEntries = [];
      let selectedRun = null;

      function setNotice(message) {
        payrollNotice.style.display = message ? 'block' : 'none';
        payrollNotice.textContent = message || '';
      }

      function setStatus(message) {
        payrollStatus.textContent = message || '';
      }

      function formatCurrency(value) {
        return `$${Number(value || 0).toFixed(2)}`;
      }

      function totalHours(hours) {
        return payTypes.reduce((sum, type) => sum + Number(hours?.[type.id] || 0), 0);
      }

      function getEmployee(entry) {
        return employees.find((employee) => employee.id === entry.employee_id);
      }

      function getRunEntries(run) {
        return paidEntries.filter((entry) => entry.start_date === run.start_date && entry.end_date === run.end_date);
      }

      function computeEarnings(entry, employee) {
        const hoursByType = payTypes.reduce((acc, type) => {
          acc[type.id] = Number(entry.hours?.[type.id] || 0);
          return acc;
        }, {});
        const total = totalHours(entry.hours);
        const rate = Number(employee?.pay_rate || 0);
        const isSalary = employee?.pay_rate_type === 'period';
        const earnings = payTypes.map((type) => {
          const hours = hoursByType[type.id];
          let amount = hours * rate;
          if (isSalary) {
            amount = type.id === 'regular' ? rate : 0;
          }
          return { id: type.id, name: type.name, hours, rate, amount };
        });
        const gross = isSalary && total > 0 ? rate : earnings.reduce((sum, line) => sum + line.amount, 0);
        return { earnings, gross, totalHours: total, rate };
      }

      function getPayPeriods(employee) {
        const scheduleName = employee?.pay_schedule || '';
        const schedule = paySchedules.find((item) => item.name === scheduleName);
        const cadence = (schedule?.cadence || scheduleName || '').toLowerCase();
        const mapping = {
          weekly: 52,
          biweekly: 26,
          semimonthly: 24,
          monthly: 12,
          quarterly: 4,
          semiannually: 2,
          daily: 260
        };
        return mapping[cadence] || 26;
      }

      function resolveFilingStatus(employee) {
        const status = employee?.w4?.filing_status;
        if (status === 'married') return 'married';
        if (status === 'head') return 'head';
        return 'single';
      }

      function lookupPercentageTable(adjustedAnnual, filingStatus, step2Checked) {
        const tables = {
          standard: {
            married: [
              [0, 19300, 0, 0, 0],
              [19300, 44100, 0, 0.1, 19300],
              [44100, 120100, 2480, 0.12, 44100],
              [120100, 230700, 11600, 0.22, 120100],
              [230700, 422850, 35932, 0.24, 230700],
              [422850, 531750, 82048, 0.32, 422850],
              [531750, 788000, 116896, 0.35, 531750],
              [788000, Infinity, 206583.5, 0.37, 788000]
            ],
            single: [
              [0, 7500, 0, 0, 0],
              [7500, 19900, 0, 0.1, 7500],
              [19900, 57900, 1240, 0.12, 19900],
              [57900, 113200, 5800, 0.22, 57900],
              [113200, 209275, 17966, 0.24, 113200],
              [209275, 263725, 41024, 0.32, 209275],
              [263725, 648100, 58448, 0.35, 263725],
              [648100, Infinity, 192979.25, 0.37, 648100]
            ],
            head: [
              [0, 15550, 0, 0, 0],
              [15550, 33250, 0, 0.1, 15550],
              [33250, 83000, 1770, 0.12, 33250],
              [83000, 121250, 7740, 0.22, 83000],
              [121250, 217300, 16155, 0.24, 121250],
              [217300, 271750, 39207, 0.32, 217300],
              [271750, 656150, 56631, 0.35, 271750],
              [656150, Infinity, 191171, 0.37, 656150]
            ]
          },
          step2: {
            married: [
              [0, 16100, 0, 0, 0],
              [16100, 28500, 0, 0.1, 16100],
              [28500, 66500, 1240, 0.12, 28500],
              [66500, 121800, 5800, 0.22, 66500],
              [121800, 217875, 17966, 0.24, 121800],
              [217875, 272325, 41024, 0.32, 217875],
              [272325, 400450, 58448, 0.35, 272325],
              [400450, Infinity, 103291.75, 0.37, 400450]
            ],
            single: [
              [0, 8050, 0, 0, 0],
              [8050, 14250, 0, 0.1, 8050],
              [14250, 33250, 620, 0.12, 14250],
              [33250, 60900, 2900, 0.22, 33250],
              [60900, 108938, 8983, 0.24, 60900],
              [108938, 136163, 20512, 0.32, 108938],
              [136163, 328350, 29224, 0.35, 136163],
              [328350, Infinity, 96489.63, 0.37, 328350]
            ],
            head: [
              [0, 12075, 0, 0, 0],
              [12075, 20925, 0, 0.1, 12075],
              [20925, 45800, 885, 0.12, 20925],
              [45800, 64925, 3870, 0.22, 45800],
              [64925, 112950, 8077.5, 0.24, 64925],
              [112950, 140175, 19603.5, 0.32, 112950],
              [140175, 332375, 28315.5, 0.35, 140175],
              [332375, Infinity, 95585.5, 0.37, 332375]
            ]
          }
        };
        const key = step2Checked ? 'step2' : 'standard';
        const table = tables[key][filingStatus];
        return table.find((row) => adjustedAnnual >= row[0] && adjustedAnnual < row[1]);
      }

      function computeFIT(gross, employee) {
        if (employee?.w4?.tax_exempt) return 0;
        const payPeriods = getPayPeriods(employee);
        const filingStatus = resolveFilingStatus(employee);
        const step2Checked = Boolean(employee?.w4?.box2c_checked);
        const step3Credits = Number(employee?.w4?.step3 || 0);
        const step4a = Number(employee?.w4?.step4a || 0);
        const step4b = Number(employee?.w4?.step4b || 0);
        const step4c = Number(employee?.w4?.step4c || 0);

        const annualized = gross * payPeriods;
        const adjustedAnnual = Math.max(
          0,
          annualized + step4a - (step4b + (step2Checked ? 0 : STANDARD_DEDUCTION[filingStatus]))
        );
        const bracket = lookupPercentageTable(adjustedAnnual, filingStatus, step2Checked);
        if (!bracket) return 0;
        const [start, , base, rate, excessOver] = bracket;
        const tentativeAnnual = base + Math.max(0, adjustedAnnual - excessOver) * rate;
        const tentativePerPeriod = tentativeAnnual / payPeriods;
        const creditPerPeriod = step3Credits / payPeriods;
        const afterCredits = Math.max(0, tentativePerPeriod - creditPerPeriod);
        return afterCredits + step4c;
      }

      function computeTaxes(gross, employee, ytdGross) {
        const w4Exempt = employee?.w4?.tax_exempt;
        const taxExemptions = employee?.tax_exemptions || {};
        const ficaExempt = Boolean(taxExemptions.fica_exempt);
        const ssOnlyExempt = Boolean(taxExemptions.ss_only_exempt);
        const fit = w4Exempt ? 0 : computeFIT(gross, employee);
        let ssTaxable = gross;
        if (ytdGross !== null) {
          ssTaxable = Math.max(0, Math.min(gross, SS_WAGE_BASE - ytdGross));
        }
        const ss = ficaExempt || ssOnlyExempt ? 0 : ssTaxable * SS_RATE;
        const medicare = ficaExempt ? 0 : gross * MEDICARE_RATE;
        const totalEmployeeTaxes = fit + ss + medicare;
        return {
          fit,
          ss,
          medicare,
          totalEmployeeTaxes
        };
      }

      function yearFromDate(dateString) {
        const [year] = (dateString || '').split('-');
        return year || '';
      }

      function sumYearToDate(employeeId, throughDate) {
        const year = yearFromDate(throughDate);
        let ytdGross = 0;
        let ytdTaxes = { fit: 0, ss: 0, medicare: 0 };
        paidEntries.forEach((entry) => {
          if (entry.employee_id !== employeeId) return;
          if (yearFromDate(entry.end_date) !== year) return;
          if (entry.end_date > throughDate) return;
          const employee = employees.find((item) => item.id === employeeId);
          if (!employee) return;
          const earnings = computeEarnings(entry, employee);
          const taxes = computeTaxes(earnings.gross, employee, ytdGross);
          ytdGross += earnings.gross;
          ytdTaxes.fit += taxes.fit;
          ytdTaxes.ss += taxes.ss;
          ytdTaxes.medicare += taxes.medicare;
        });
        return { ytdGross, ytdTaxes };
      }

      function buildRunSummary(run) {
        const entries = getRunEntries(run);
        const summary = entries.reduce(
          (acc, entry) => {
            const employee = getEmployee(entry);
            if (!employee) return acc;
            const earnings = computeEarnings(entry, employee);
            const { ytdGross } = sumYearToDate(employee.id, entry.end_date);
            const taxes = computeTaxes(earnings.gross, employee, ytdGross - earnings.gross);
            acc.totalHours += earnings.totalHours;
            acc.totalGross += earnings.gross;
            acc.totalNet += Math.max(0, earnings.gross - taxes.totalEmployeeTaxes);
            acc.employeeCount += 1;
            return acc;
          },
          { totalHours: 0, totalGross: 0, totalNet: 0, employeeCount: 0 }
        );
        return summary;
      }

      function renderRuns() {
        runsBody.innerHTML = '';
        payrollRuns.forEach((run) => {
          const summary = buildRunSummary(run);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <strong>${run.label || `${run.start_date} → ${run.end_date}`}</strong>
              <div class="muted" style="margin-top: 4px;">${run.start_date} → ${run.end_date}</div>
            </td>
            <td>${summary.employeeCount}</td>
            <td class="right">${summary.totalHours.toFixed(2)}</td>
            <td class="right">${formatCurrency(summary.totalGross)}</td>
            <td class="right">${formatCurrency(summary.totalNet)}</td>
            <td>
              <button class="btn secondary small" data-run-id="${run.id}">View details</button>
            </td>
          `;
          runsBody.appendChild(row);
        });

        if (!payrollRuns.length) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="6" class="muted">No payroll runs yet.</td>`;
          runsBody.appendChild(row);
        }
      }

      function renderDetails(run) {
        selectedRun = run;
        detailsEmpty.style.display = 'none';
        detailsPanel.style.display = 'block';
        runLabelInput.value = run.label || '';
        runActionStatus.textContent = '';
        detailsBody.innerHTML = '';

        const entries = getRunEntries(run);
        entries.forEach((entry) => {
          const employee = getEmployee(entry);
          if (!employee) return;
          const earnings = computeEarnings(entry, employee);
          const { ytdGross } = sumYearToDate(employee.id, entry.end_date);
          const taxes = computeTaxes(earnings.gross, employee, ytdGross - earnings.gross);
          const netPay = Math.max(0, earnings.gross - taxes.totalEmployeeTaxes);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <strong>${employee.name || 'Employee'}</strong>
              <div class="muted" style="margin-top: 4px;">${employee.department || 'No department'}</div>
            </td>
            <td class="right">${earnings.totalHours.toFixed(2)}</td>
            <td class="right">${formatCurrency(earnings.gross)}</td>
            <td class="right">${formatCurrency(netPay)}</td>
            <td class="right">
              <button class="btn ghost small" data-stub-id="${entry.id}">Preview pay stub</button>
            </td>
          `;
          detailsBody.appendChild(row);
        });

        if (!entries.length) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="5" class="muted">No paid entries for this run.</td>`;
          detailsBody.appendChild(row);
        }
      }

      function openStub(entryId) {
        const entry = paidEntries.find((item) => item.id === entryId);
        if (!entry || !selectedRun) return;
        const employee = getEmployee(entry);
        if (!employee) return;
        const earnings = computeEarnings(entry, employee);
        const ytd = sumYearToDate(employee.id, entry.end_date);
        const taxes = computeTaxes(earnings.gross, employee, ytd.ytdGross - earnings.gross);
        const netPay = Math.max(0, earnings.gross - taxes.totalEmployeeTaxes);
        const totalDeductions = taxes.totalEmployeeTaxes;
        const ytdNet = Math.max(0, ytd.ytdGross - (ytd.ytdTaxes.fit + ytd.ytdTaxes.ss + ytd.ytdTaxes.medicare));

        stubSubtitle.textContent = `${employee.name || 'Employee'} • ${selectedRun.start_date} → ${selectedRun.end_date}`;
        stubContent.innerHTML = `
          <div class="stub-grid">
            <div>
              <h4 style="margin-top: 0;">Earnings</h4>
              <table class="table compact">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th class="right">Hours</th>
                    <th class="right">Rate</th>
                    <th class="right">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${earnings.earnings
                    .map(
                      (line) => `
                        <tr>
                          <td>${line.name}</td>
                          <td class="right">${line.hours.toFixed(2)}</td>
                          <td class="right">${formatCurrency(line.rate)}</td>
                          <td class="right">${formatCurrency(line.amount)}</td>
                        </tr>
                      `
                    )
                    .join('')}
                  <tr>
                    <td colspan="3" class="right"><strong>Total earnings</strong></td>
                    <td class="right"><strong>${formatCurrency(earnings.gross)}</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div>
              <h4 style="margin-top: 0;">Taxes</h4>
              <table class="table compact">
                <thead>
                  <tr>
                    <th>Tax</th>
                    <th class="right">This check</th>
                    <th class="right">Year to date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Federal Income Tax</td>
                    <td class="right">${formatCurrency(taxes.fit)}</td>
                    <td class="right">${formatCurrency(ytd.ytdTaxes.fit)}</td>
                  </tr>
                  <tr>
                    <td>Social Security</td>
                    <td class="right">${formatCurrency(taxes.ss)}</td>
                    <td class="right">${formatCurrency(ytd.ytdTaxes.ss)}</td>
                  </tr>
                  <tr>
                    <td>Medicare</td>
                    <td class="right">${formatCurrency(taxes.medicare)}</td>
                    <td class="right">${formatCurrency(ytd.ytdTaxes.medicare)}</td>
                  </tr>
                  <tr>
                    <td><strong>Total employee taxes</strong></td>
                    <td class="right"><strong>${formatCurrency(taxes.totalEmployeeTaxes)}</strong></td>
                    <td class="right"><strong>${formatCurrency(ytd.ytdTaxes.fit + ytd.ytdTaxes.ss + ytd.ytdTaxes.medicare)}</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div>
              <h4 style="margin-top: 0;">Summary</h4>
              <div class="summary-card">
                <div>
                  <p class="muted">Gross pay</p>
                  <p>${formatCurrency(earnings.gross)}</p>
                </div>
                <div>
                  <p class="muted">Total deductions</p>
                  <p>${formatCurrency(totalDeductions)}</p>
                </div>
                <div>
                  <p class="muted">Net pay</p>
                  <p>${formatCurrency(netPay)}</p>
                </div>
                <div>
                  <p class="muted">YTD gross</p>
                  <p>${formatCurrency(ytd.ytdGross)}</p>
                </div>
                <div>
                  <p class="muted">YTD net</p>
                  <p>${formatCurrency(ytdNet)}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        stubModal.classList.add('is-open');
        stubModal.setAttribute('aria-hidden', 'false');
      }

      function closeModal() {
        stubModal.classList.remove('is-open');
        stubModal.setAttribute('aria-hidden', 'true');
      }

      async function loadData() {
        setStatus('Loading payroll runs...');
        try {
          const [employeesRes, payTypesRes, entriesRes, runsRes, schedulesRes] = await Promise.all([
            fetch('/api/employees'),
            fetch('/api/pay-types'),
            fetch('/api/time-entries?status=paid'),
            fetch('/api/payroll-runs'),
            fetch('/api/pay-schedules')
          ]);
          const employeesPayload = await employeesRes.json();
          const payTypesPayload = await payTypesRes.json();
          const entriesPayload = await entriesRes.json();
          const runsPayload = await runsRes.json();
          const schedulesPayload = await schedulesRes.json();
          employees = employeesPayload.employees || [];
          payTypes = payTypesPayload.payTypes || [];
          paidEntries = entriesPayload.entries || [];
          payrollRuns = runsPayload.runs || [];
          paySchedules = schedulesPayload.paySchedules || [];
          if (!payTypes.length) {
            payTypes = [
              { id: 'regular', name: 'Regular' },
              { id: 'vacation', name: 'Vacation' },
              { id: 'holiday', name: 'Holiday' }
            ];
          }
          renderRuns();
          const params = new URLSearchParams(window.location.search);
          const runId = params.get('run');
          const selected = payrollRuns.find((run) => run.id === runId);
          if (selected) {
            renderDetails(selected);
          }
          setStatus(payrollRuns.length ? 'Select a payroll run to view details.' : 'No payroll runs yet.');
        } catch (error) {
          console.error('Failed to load payroll runs', error);
          setNotice('Unable to load payroll runs.');
        }
      }

      runsBody.addEventListener('click', (event) => {
        const btn = event.target.closest('[data-run-id]');
        if (!btn) return;
        const runId = btn.dataset.runId;
        const run = payrollRuns.find((item) => item.id === runId);
        if (run) renderDetails(run);
      });

      detailsBody.addEventListener('click', (event) => {
        const btn = event.target.closest('[data-stub-id]');
        if (!btn) return;
        openStub(btn.dataset.stubId);
      });

      saveLabelBtn.addEventListener('click', async () => {
        if (!selectedRun) return;
        runActionStatus.textContent = 'Saving...';
        try {
          const response = await fetch('/api/payroll-runs/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ run_id: selectedRun.id, label: runLabelInput.value })
          });
          const payload = await response.json();
          if (!response.ok) throw new Error(payload.error || 'Unable to update run');
          selectedRun.label = payload.run.label;
          renderRuns();
          runActionStatus.textContent = 'Saved.';
        } catch (error) {
          runActionStatus.textContent = error.message || 'Unable to save.';
        }
      });

      deleteRunBtn.addEventListener('click', async () => {
        if (!selectedRun) return;
        runActionStatus.textContent = 'Deleting...';
        try {
          const response = await fetch('/api/payroll-runs/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ run_id: selectedRun.id })
          });
          const payload = await response.json();
          if (!response.ok) throw new Error(payload.error || 'Unable to delete run');
          payrollRuns = payload.runs || [];
          selectedRun = null;
          detailsPanel.style.display = 'none';
          detailsEmpty.style.display = 'block';
          renderRuns();
          runActionStatus.textContent = 'Deleted. Hours were not removed.';
        } catch (error) {
          runActionStatus.textContent = error.message || 'Unable to delete.';
        }
      });

      stubModal.addEventListener('click', (event) => {
        if (event.target.matches('[data-close]')) {
          closeModal();
        }
      });

      loadData();
    </script>
  </body>
</html>
