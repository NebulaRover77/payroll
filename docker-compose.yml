services:
  wizard:
    build:
      context: .
      dockerfile: Dockerfile.wizard
    command: npm start
    environment:
      - ADMIN_TOKEN=changeme
      - PORT=3000
    ports:
      - "3000:3000"
    volumes:
      - payroll_data:/app/data

  api:
    build: ./backend
    working_dir: /app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      - PAYROLL_ENV=dev
      - PAYROLL_DATABASE_URL=postgresql://postgres:postgres@db:5432/payroll
      - PAYROLL_LOG_LEVEL=DEBUG
      - PAYROLL_OTLP_ENDPOINT=http://otel-collector:4318
      - PYTHONPATH=/app
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    depends_on:
      - db
      - otel-collector

  console:
    build:
      context: ./frontend/console
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - api

  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: payroll
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  otel-collector:
    image: otel/opentelemetry-collector:0.97.0
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./infra/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4318:4318"
      - "4317:4317"
    depends_on:
      - jaeger

  jaeger:
    image: jaegertracing/all-in-one:1.57
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"

volumes:
  pg_data:
  payroll_data:
